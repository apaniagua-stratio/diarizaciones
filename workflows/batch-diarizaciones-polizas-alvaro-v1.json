{"id":"9d4db8d6-d9d1-4541-aecd-0ae5738107b6","name":"batch-diarizaciones-polizas-alvaro","description":"","settings":{"global":{"executionMode":"marathon","userPluginsJars":[],"initSqlSentences":[{"sentence":"CREATE TEMPORARY TABLE XPOLIZAS USING PARQUET OPTIONS (path '{{NINF_STAGING}}/XPOLIZAS')"},{"sentence":"CREATE TEMPORARY TABLE XPOLIZAS_COMUN USING PARQUET OPTIONS (path '{{NINF_STAGING}}/XPOLIZAS_COMUN')"},{"sentence":"CREATE TEMPORARY TABLE TGRRECIB USING PARQUET OPTIONS (path '{{NINF_STAGING}}/TGRRECIB')"},{"sentence":"CREATE TEMPORARY TABLE TAUDACON USING PARQUET OPTIONS (path '{{NINF_STAGING}}/TAUDACON')"},{"sentence":"CREATE TEMPORARY TABLE NEGOCIOS_HISTORICO USING PARQUET OPTIONS (path '{{NINF_STAGING}}/NEGOCIOS_HISTORICO')"},{"sentence":"CREATE TEMPORARY TABLE TUCNEGME USING PARQUET OPTIONS (path '{{NINF_STAGING}}/TUCNEGME')"},{"sentence":"CREATE TEMPORARY TABLE XESTRCOMER_PERSONAL USING PARQUET OPTIONS (path '{{NINF_STAGING}}/XESTRCOMER_PERSONAL')"},{"sentence":"CREATE TEMPORARY TABLE TAMMOVRE USING PARQUET OPTIONS (path '{{NINF_STAGING}}/TAMMOVRE')"},{"sentence":"CREATE TEMPORARY TABLE TGRDESGL USING PARQUET OPTIONS (path '{{NINF_STAGING}}/TGRDESGL')"},{"sentence":"CREATE TEMPORARY TABLE PRODUCTOSGARANTIAS USING PARQUET OPTIONS (path '{{NINF_STAGING}}/PRODUCTOSGARANTIAS')"}],"addAllUploadedPlugins":true,"mesosConstraint":"","mesosConstraintOperator":"CLUSTER"},"streamingSettings":{"window":"2s","blockInterval":"100ms","checkpointSettings":{"checkpointPath":"sparta/checkpoint","enableCheckpointing":true,"autoDeleteCheckpoint":true,"addTimeToCheckpointPath":false}},"sparkSettings":{"master":"{{SPARK_MASTER}}","sparkKerberos":true,"sparkDataStoreTls":true,"sparkMesosSecurity":true,"submitArguments":{"userArguments":[],"deployMode":"client","driverJavaOptions":"{{{SPARK_DRIVER_JAVA_OPTIONS}}}"},"sparkConf":{"sparkResourcesConf":{"coresMax":"24","executorMemory":"32G","executorCores":"4","driverCores":"{{SPARK_DRIVER_CORES}}","driverMemory":"16G","mesosExtraCores":"","localityWait":"{{SPARK_LOCALITY_WAIT}}","taskMaxFailures":"{{SPARK_TASK_MAX_FAILURES}}","sparkMemoryFraction":"0.8","sparkParallelism":""},"userSparkConf":[{"sparkConfKey":"spark.sql.shuffle.partitions","sparkConfValue":"2040"}],"coarse":true,"sparkUser":"{{SPARK_USER}}","sparkLocalDir":"{{SPARK_LOCAL_PATH}}","executorDockerImage":"{{SPARK_EXECUTOR_BASE_IMAGE}}","sparkKryoSerialization":true,"sparkSqlCaseSensitive":true,"logStagesProgress":false,"hdfsTokenCache":true,"executorExtraJavaOptions":"{{{SPARK_EXECUTOR_EXTRA_JAVA_OPTIONS}}}"}},"errorsManagement":{"genericErrorManagement":{"whenError":"Error"},"transformationStepsManagement":{"whenError":"Error","whenRowError":"RowError","whenFieldError":"FieldError"},"transactionsManagement":{"sendToOutputs":[],"sendStepData":false,"sendPredecessorsData":true,"sendInputData":true}}},"pipelineGraph":{"nodes":[{"name":"Renting","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"RentingTb","partitionBy":"","errorTableName":""},"description":"In","uiConfiguration":{"position":{"x":2751.8666582358724,"y":917.4170770344688}},"configuration":{"sql":"select  AMMOVRE_ID_POLIZA,\n\t\tAMMOVRE_F_EFECTO,\n\t\tAMMOVRE_COD_MOVIM,\n\t\tAMMOVRE_DURACION,\n\t\tMAX(AMMOVRE_ID_SECUEN) as AMMOVRE_ID_SECUEN\n\tFROM FilterTammovre \n\tgroup by AMMOVRE_ID_POLIZA,AMMOVRE_F_EFECTO,AMMOVRE_COD_MOVIM,AMMOVRE_DURACION","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"RentingAcum","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"RentingAcumTb","partitionBy":"","errorTableName":""},"description":"In","uiConfiguration":{"position":{"x":2751.7360189487727,"y":1054.9832883875813}},"configuration":{"sql":"\tselect M.AMMOVRE_ID_POLIZA,M.AMMOVRE_F_EFECTO,M.AMMOVRE_DURACION, \n\t\t\t\t   REN.AMMOVRE_F_EFECTO as AMMOVRE_F_EFECTO_2,\n\t\t\t\t   REN.AMMOVRE_DURACION AS AMMOVRE_DURACION_2\n\t\t\tfrom Renting M\n\t\t\tleft join Renting REN\n\t\t\ton M.AMMOVRE_ID_POLIZA = REN.AMMOVRE_ID_POLIZA\n\t\t\tand M.AMMOVRE_F_EFECTO >= REN.AMMOVRE_F_EFECTO\n\t\t\t","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"RentingTotal","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"description":"In","uiConfiguration":{"position":{"x":2752.2556751238913,"y":1193.3743952242908}},"configuration":{"sql":"SELECT AMMOVRE_ID_POLIZA,AMMOVRE_F_EFECTO,\n\tCAST(AMMOVRE_DURACION AS INT),\n\tCAST(SUM(AMMOVRE_DURACION_2) AS INT) AS AMMOVRE_DURACION_TOTAL\nFROM RentingAcum\nGROUP BY AMMOVRE_ID_POLIZA,AMMOVRE_F_EFECTO,AMMOVRE_DURACION\n\t\t\t","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"RentingTotalDistinct","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"description":"In","uiConfiguration":{"position":{"x":2752.998850280605,"y":1334.4129497504464}},"configuration":{"sql":"SELECT DISTINCT AMMOVRE_ID_POLIZA, TO_DATE('2050-12-31') as AMMOVRE_F_EFECTO,\n\tCAST(0 AS INT) as AMMOVRE_DURACION, \n\tCAST(0 AS INT) as AMMOVRE_DURACION_TOTAL\n\tFROM RentingTotal \nUNION\nSELECT AMMOVRE_ID_POLIZA,AMMOVRE_F_EFECTO,AMMOVRE_DURACION,AMMOVRE_DURACION_TOTAL FROM RentingTotal\n\n\t\t\t","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"RentingPeriodos","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"description":"","uiConfiguration":{"position":{"x":2752.8450810380814,"y":1466.540851881899}},"configuration":{"sql":"select R1.AMMOVRE_ID_POLIZA,\n\tR1.AMMOVRE_F_EFECTO as AMMOVRE_F_EFECTO_Ini,\n\tdate_sub(R2.AMMOVRE_F_EFECTO,1) as AMMOVRE_F_EFECTO_Fin,\n\tR1.AMMOVRE_DURACION,R1.AMMOVRE_DURACION_TOTAL\nfrom RentingTotalDistinct R1\njoin RentingTotalDistinct R2\non R1.AMMOVRE_ID_POLIZA = R2.AMMOVRE_ID_POLIZA\nand R1.AMMOVRE_F_EFECTO < R2.AMMOVRE_F_EFECTO\n\n","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"DiarizacionPolizas","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"description":"","uiConfiguration":{"position":{"x":2754.211359634765,"y":1738.335419358122}},"configuration":{"sql":"select \n/*+ SKEW('FilterProductosGarantias', ('Producto')) */ \n/*+ SKEW('PG', ('Producto')) */ \n\txpol.IdPeriodo,    \n\txpol.apolclav,    \n\t\n\txpol.FIni,    \n\txpol.FFin,    \n\tdatediff(xpol.FFin,xpol.FIni)+1 as NDias,\n\tmax(case when NVL(xpol.GRDESGL_COD_GARAN, PG.RCObligatorio)=1 then 1 else 0 end) as RcObligatorio, \n\tmax(case when NVL(xpol.GRDESGL_COD_GARAN, PG.RCVoluntario) =2 then 1 else 0 end) as RcVoluntario,\n\t--MAX(\n\t--case when NVL(xpol.GRDESGL_COD_GARAN,CAST(PG.Da?osPropios AS INT)*3)=3 then 1\n\t--\telse 0 end as DanosPropios,\n\t--end) as DanosPropios,\n\tmax(case when NVL(xpol.GRDESGL_COD_GARAN, PG.Accidentes)=4 then 1 else 0 end) as Accidentes,\n\tmax(case when NVL(xpol.GRDESGL_COD_GARAN, PG.Robo)=5 then 1 else 0 end) as Robo,\n\tmax(case when NVL(xpol.GRDESGL_COD_GARAN, PG.DefensaJuridica)=6 then 1 else 0 end) as DefensaJuridica,\n\tmax(case when NVL(xpol.GRDESGL_COD_GARAN, PG.Acm)=7 then 1 else 0 end) as Acm,\n\tmax(case when NVL(xpol.GRDESGL_COD_GARAN, PG.Lunas)=8 then 1 else 0 end) as Lunas,\n\tmax(case when NVL(xpol.GRDESGL_COD_GARAN, PG.Incendio)=9 then 1 else 0 end) as Incendios,\t\n\tmax(case when NVL(xpol.GRDESGL_COD_GARAN,0)=10 then 1 else 0 end) as GarantiaMecanica,\n\t0 as Renting,\n\tmax(xpol.FrecuenciaPago) AS FrecuenciaPago, \n\txpol.Cambio_Caracteristica,    \n\txpol.Grupo,    \n\txpol.FAno as Ano,\n\txpol.FechaMovini,\n\txpol.IdPersonalComercial,\n\txpol.Colectivo,\n\txpol.Flota,\n\txpol.IdTipoSubNegocio,\n\txpol.audacon_ffin_contr\nFROM Step7 xpol\nleft join FilterProductosGarantias PG\n on xpol.GRRECIB_PRODUCTO=PG.Producto \n where xpol.FIni>=TO_DATE('{{DIARIZACIONES_INICIO}}') and xpol.FIni<= TO_DATE('{{DIARIZACIONES_FECHA}}')\n \n GROUP BY\n\txpol.IdPeriodo,\n\txpol.apolclav,\n\txpol.FIni,\n\txpol.FFin,\n--\tFIni, ?es redundante?\n\txpol.Cambio_Caracteristica,\n\txpol.Grupo,\n\txpol.Colectivo,\n\txpol.Flota,\n\txpol.IdPersonalComercial,\t\t\n\txpol.FAno,\n\txpol.IdTipoSubNegocio,\n\txpol.audacon_ffin_contr,\n\txpol.FechaMovini\n","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"RentingPeriodosGroup","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"description":"In","uiConfiguration":{"position":{"x":2753.964008710968,"y":1601.8899648305267}},"configuration":{"sql":"select AMMOVRE_ID_POLIZA , \n\tAMMOVRE_F_EFECTO_Ini,min(AMMOVRE_F_EFECTO_Fin) as AMMOVRE_F_EFECTO_Fin,AMMOVRE_DURACION_TOTAL\nfrom RentingPeriodos \ngroup by AMMOVRE_ID_POLIZA, AMMOVRE_F_EFECTO_Ini, AMMOVRE_DURACION_TOTAL\n\n","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"GroupFechas","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2525.6078854999528,"y":270.1669693300861}},"configuration":{"sql":"select\n\tapolclav,\n\tFechaEstudio,\n\tMax(FechaEstudio) as FechaEstudioMax,\n\tMax(Tipo) as Tipo\nfrom \n\tUnionFechas\ngroup by apolclav,FechaEstudio\n","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"PeriodosEstudio","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2525.5058187678346,"y":399.35541403475077}},"configuration":{"sql":"\tSELECT \n\t\tbase64(concat(apolclav,FechaEstudio,Tipo)) as IdPeriodo,\n\t\tapolclav,\n\t\tFechaEstudio as FIni,\n\t\tyear(FechaEstudio) as FAno,\n\t\tDATE_ADD(FechaEstudioMax,1) as FFin,\n\t\tCASE\n\t\t\tWHEN Tipo=0 THEN 0\n\t\t\tELSE 1\n\t\t\tEND AS Cambio_Caracteristica\n\tFROM GroupFechas \n","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"PeriodosEstudioGrupos","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2524.5981226277854,"y":534.9563557943129}},"configuration":{"sql":"select \n\tIdPeriodo,\n\tCAST(apolclav AS INT) AS apolclav,\n\tTO_DATE(FIni) AS FIni,\n\tTO_DATE(FFin) AS FFin,\n\tCAST(FAno AS INT) AS FAno,\n\tCAST(Cambio_Caracteristica AS INT) AS Cambio_Caracteristica,\n\tdense_rank() OVER (PARTITION BY apolclav,FAno ORDER BY FIni DESC) as Grupo\nfrom\n\tPeriodosEstudio\n","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"UnionFechas","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2285.72595734511,"y":271.7388968258633}},"configuration":{"sql":"--movimientos polizas\n(\n  SELECT \n\tep.apolclav,\n  \tTO_DATE(c.FechaMovini) as FechaEstudio,\n  \t1 as Tipo \n  FROM \n\t  XPOLIZAS c \n  JOIN \n\t  PolizasEstudio ep\n  ON \n\t  c.Apolclav=ep.apolclav\n  WHERE \n\t  TO_DATE(c.FechaMovini) between TO_DATE(ep.FechaEntradaEstudio) and TO_DATE('{{DIARIZACIONES_FECHA}}')  \t\n)  \n\nUNION ALL\n-- fechas recibos\n\n(\n  SELECT \n\tep.apolclav as apolclav,\n\t\tCASE \n\t\tWHEN Rec.GRRECIB_FECH_VENC=Rec.GRRECIB_FECH_EFE then DATE_ADD(TO_DATE(Rec.GRRECIB_FECH_VENC),1)\n\t\tELSE TO_DATE(Rec.GRRECIB_FECH_VENC) \n\t\tEND \n  \tAS FechaEstudio,\n\t20 AS Tipo \n  FROM \n\t  TGRRECIB Rec JOIN PolizasEstudio ep\n  ON \n\t  Rec.GRRECIB_ID_ADHES=ep.apolclav\n  WHERE \n\t  Rec.GRRECIB_EMPRESA in (1,3)\n\t  AND\tRec.GRRECIB_FECH_VENC >= ep.FechaEntradaEstudio AND Rec.GRRECIB_FECH_VENC <= TO_DATE('{{DIARIZACIONES_FECHA}}')\n  UNION ALL\n  SELECT \n\tep.apolclav AS apolclav,\n  \tTO_DATE(Rec.GRRECIB_FECH_VENC) AS FechaEstudio,\n  \t21 AS Tipo \n  FROM \n\t  TGRRECIB Rec JOIN PolizasEstudio ep\n  ON \n\t  Rec.GRRECIB_ID_ADHES=ep.apolclav\n  WHERE \n\t  Rec.GRRECIB_EMPRESA IN (1,3) \n\t  AND\tRec.GRRECIB_FECH_EFE >= ep.FechaEntradaEstudio AND Rec.GRRECIB_FECH_EFE <= TO_DATE('{{DIARIZACIONES_FECHA}}')\n  UNION ALL\n  SELECT\n  \tep.apolclav AS apolclav,\n  \tTO_DATE(Rec.GRRECIB_FECH_VENC) AS FechaEstudio,\n  \t23 AS Tipo \n  FROM \n\t  TGRRECIB Rec JOIN PolizasEstudio ep\n  ON Rec.GRRECIB_ID_ADHES=ep.apolclav\n  WHERE \n\t  Rec.GRRECIB_EMPRESA IN (1,3) AND \n\t  Rec.GRRECIB_TIP_RECI='010' AND\n\t  Rec.GRRECIB_FECH_EFE=Rec.GRRECIB_FECH_VENC AND\n\t  Rec.GRRECIB_FECH_EFE >= ep.FechaEntradaEstudio AND Rec.GRRECIB_FECH_EFE <= TO_DATE('{{DIARIZACIONES_FECHA}}')\n)\t\n\nUNION ALL\n--cambios frt\n(\n  SELECT Apolclav, \n\t  TO_DATE(concat(ano, '-', month(Frt),'-',dayofmonth(Frt))) as FechaEstudio,\n\t  0 as Tipo\n  FROM\n  (\n\t  (\n\t  SELECT distinct xp.Apolclav, xp.Frt, ep.FechaEntradaEstudio \n\t\t  FROM PolizasEstudio ep JOIN XPOLIZAS xp \n\t\t  ON ep.apolclav = xp.Apolclav\n\t  ) as frts\n\t  CROSS JOIN  \t \n\t  (\n\t  SELECT distinct year(FinMes) as ano \n\t\t  from CsvMeses \n\t\t  WHERE FinMes between TO_DATE('{{DIARIZACIONES_INICIO}}') and TO_DATE('{{DIARIZACIONES_FECHA}}')\n\t  ) as anos\n  ) \n  WHERE TO_DATE(concat(ano, '-', month(Frt),'-',dayofmonth(Frt))) between TO_DATE(FechaEntradaEstudio) and TO_DATE('{{DIARIZACIONES_FECHA}}')\n)\n--frt ocasional\nUNION ALL\n\n(\n  SELECT Apolclav, \n\t  TO_DATE(concat(ano, '-', month(FRTCROcasional),'-',dayofmonth(FRTCROcasional))) as FechaEstudio,\n\t  0 as Tipo\n  FROM\n  (\n\t  (\n\t  SELECT distinct xp.Apolclav, xp.FRTCROcasional, ep.FechaEntradaEstudio \n\t\t  FROM PolizasEstudio ep JOIN XPOLIZAS xp \n\t\t  ON ep.apolclav = xp.Apolclav\n\t  ) as frtsOca\n\t  CROSS JOIN  \t \n\t  (\n\t  SELECT distinct year(FinMes) as ano \n\t\t  from CsvMeses \n\t\t  WHERE FinMes between TO_DATE('{{DIARIZACIONES_INICIO}}') and TO_DATE('{{DIARIZACIONES_FECHA}}')\n\t  ) as anosOca\n  ) \n  WHERE TO_DATE(concat(ano, '-', month(FRTCROcasional),'-',dayofmonth(FRTCROcasional))) between TO_DATE(FechaEntradaEstudio) and TO_DATE('{{DIARIZACIONES_FECHA}}')\n)\n\nUNION ALL\n\n--cumple del conductor\n(\nselect \n    ep.apolclav,\n    TO_DATE(concat(mes.ano,'-',month(pol.FnacConductor),'-',dayofmonth(pol.FnacConductor))) as FechaEstudio,\n    0 as Tipo                        \nfrom \n    PolizasEstudio ep\njoin\n    XPOLIZAS pol \non\n    ep.apolclav=pol.Apolclav\njoin\n    (\n      select distinct year(FinMes) as ano from CsvMeses  --no seria necesario tanto calculo pero lo dejamos como en transact\n        where \n            (\n\t\t\t  year(FinMes) between year(to_date('{{DIARIZACIONES_INICIO}}')) and year(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)) -1\n                                        and month(FinMes) = 12\n\t\t\t) \n            or \n            (\n\t\t\t month(FinMes) = month(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)) - 1\n             and year(FinMes) = year(date_add(to_date('{{DIARIZACIONES_FECHA}}'), 1))\n\t\t\t)\n      --select distinct year(FinMes) as ano from CsvMeses where FinMes between to_date('{{DIARIZACIONES_INICIO}}') and to_date('{{DIARIZACIONES_FECHA}}')\n    ) as mes \non \n    TO_DATE(concat(mes.ano,'-',month(pol.FnacConductor),'-',dayofmonth(pol.FnacConductor))) between pol.FechaMovini and pol.FechaMovFin\nwhere \n    TO_DATE(concat(mes.ano,'-',month(pol.FnacConductor),'-',dayofmonth(pol.FnacConductor))) between to_date('{{DIARIZACIONES_INICIO}}') and to_date('{{DIARIZACIONES_FECHA}}')\n)\n\nUNION ALL \n\n--cumple del ocasional\n(\nselect \n    ep.apolclav,\n    TO_DATE(concat(mes.ano,'-',month(pol.FNacCROcasional),'-',dayofmonth(pol.FNacCROcasional))) as FechaEstudio,\n    0 as Tipo                        \nfrom \n    PolizasEstudio ep\njoin\n    XPOLIZAS pol \non\n    ep.apolclav=pol.Apolclav\njoin\n    (\n     select distinct year(FinMes) as ano from CsvMeses  --no seria necesario tanto calculo pero lo dejamos como en transact\n\t\twhere \n\t\t(\n\t\t  year(FinMes) between year(to_date('{{DIARIZACIONES_INICIO}}')) and year(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)) -1\n\t\t  and month(FinMes) = 12\n\t\t) \n\t\tor \n\t\t(\n\t\t  month(FinMes) = month(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)) - 1\n\t\t  and year(FinMes) = year(date_add(to_date('{{DIARIZACIONES_FECHA}}'), 1))\n\t\t)\n\t  --select distinct year(FinMes) as ano from CsvMeses where FinMes between to_date('{{DIARIZACIONES_INICIO}}') and to_date('{{DIARIZACIONES_FECHA}}')\n    ) as mes \non \n    TO_DATE(concat(mes.ano,'-',month(pol.FNacCROcasional),'-',dayofmonth(pol.FNacCROcasional))) between pol.FechaMovini and pol.FechaMovFin\nwhere \n    TO_DATE(concat(mes.ano,'-',month(pol.FNacCROcasional),'-',dayofmonth(pol.FNacCROcasional))) between to_date('{{DIARIZACIONES_INICIO}}') and to_date('{{DIARIZACIONES_FECHA}}')\n)\t\n\t\nUNION ALL\n-- cumple del vehiculo\n\n(\nselect \n    ep.apolclav,\n    TO_DATE(concat(mes.ano,'-',month(pol.FechaConstruccion),'-',dayofmonth(pol.FechaConstruccion))) as FechaEstudio,\n    0 as Tipo                        \nfrom \n    PolizasEstudio ep\njoin\n    XPOLIZAS pol \non\n    ep.apolclav=pol.Apolclav\njoin\n    (\n      select distinct year(FinMes) as ano from CsvMeses  --no seria necesario tanto calculo pero lo dejamos como en transact\n        where \n            (\n\t\t\t  year(FinMes) between year(to_date('{{DIARIZACIONES_INICIO}}')) and year(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)) -1\n                                        and month(FinMes) = 12\n\t\t\t) \n            or \n            (\n\t\t\t month(FinMes) = month(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)) - 1\n             and year(FinMes) = year(date_add(to_date('{{DIARIZACIONES_FECHA}}'), 1))\n\t\t\t)\n\t  --select distinct year(FinMes) as ano from CsvMeses where FinMes between to_date('{{DIARIZACIONES_INICIO}}') and to_date('{{DIARIZACIONES_FECHA}}')\n    ) as mes \non \n    TO_DATE(concat(mes.ano,'-',month(pol.FechaConstruccion),'-',dayofmonth(pol.FechaConstruccion))) between pol.FechaMovini and pol.FechaMovFin\nwhere \n    TO_DATE(concat(mes.ano,'-',month(pol.FechaConstruccion),'-',dayofmonth(pol.FechaConstruccion))) between to_date('{{DIARIZACIONES_INICIO}}') and to_date('{{DIARIZACIONES_FECHA}}')\t\n)\t\n\nUNION ALL\n\n--cumple del tomador\n\n(\nselect \n    ep.apolclav,\n    TO_DATE(concat(mes.ano,'-',month(pol.FnacTomador),'-',dayofmonth(pol.FnacTomador))) as FechaEstudio,\n    0 as Tipo                        \nfrom \n    PolizasEstudio ep\njoin\n    XPOLIZAS pol \non\n    ep.apolclav=pol.Apolclav\njoin\n    (\n      select distinct year(FinMes) as ano from CsvMeses  --no seria necesario tanto calculo pero lo dejamos como en transact\n        where \n            (\n\t\t\t  year(FinMes) between year(to_date('{{DIARIZACIONES_INICIO}}')) and year(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)) -1\n                                        and month(FinMes) = 12\n\t\t\t) \n            or \n            (\n\t\t\t month(FinMes) = month(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)) - 1\n             and year(FinMes) = year(date_add(to_date('{{DIARIZACIONES_FECHA}}'), 1))\n\t\t\t)\n      --select distinct year(FinMes) as ano from CsvMeses where FinMes between to_date('{{DIARIZACIONES_INICIO}}') and to_date('{{DIARIZACIONES_FECHA}}')\n    ) as mes \non \n    TO_DATE(concat(mes.ano,'-',month(pol.FnacTomador),'-',dayofmonth(pol.FnacTomador))) between pol.FechaMovini and pol.FechaMovFin\nwhere \n    TO_DATE(concat(mes.ano,'-',month(pol.FnacTomador),'-',dayofmonth(pol.FnacTomador))) between to_date('{{DIARIZACIONES_INICIO}}') and to_date('{{DIARIZACIONES_FECHA}}')\n)\n\nUNION ALL\n\n\t--antiguedad polizas\n(\n\tselect \n\t\tapolclav,\n\t\tcase when concat(month(FechaEntrada),'-',dayofmonth(FechaEntrada)) = '2-29'\n\t\t then TO_DATE(concat(ano,'-','2-28'))\n\t\telse \n\t\t TO_DATE(concat(ano,'-',month(FechaEntrada),'-',dayofmonth(FechaEntrada)))\n\t\tend \n\t  \tas FechaEstudio,\n\t\t0 as Tipo\n\tfrom\n\t\tPolizasEstudio pol\n\tcross join\n\t\t(\n\t\tselect distinct \n\t\t\tyear(FinMes) as ano\n\t\tfrom \n\t\t\tCsvMeses \n\t\twhere \n\t\t\tFinMes between to_date('{{DIARIZACIONES_INICIO}}') and to_date('{{DIARIZACIONES_FECHA}}')\n\t\t) as fec\n\twhere TO_DATE(concat(ano,'-',month(FechaEntrada),'-',dayofmonth(FechaEntrada))) between FechaEntradaEstudio and TO_DATE('{{DIARIZACIONES_FECHA}}')\n)\n\n\n--fechas efecto duracion contrato renting (para globalis)\nUNION ALL\n\n(\n  SELECT \n\tep.apolclav,\n  \tTO_DATE(Ren.AMMOVRE_F_EFECTO) as FechaEstudio,\n  \t0 as Tipo \n  FROM \n\tPolizasEstudio ep  \n  JOIN \n\tTAMMOVRE Ren\n  ON \n\tep.apolclav = Ren.AMMOVRE_ID_POLIZA\n  WHERE \n\tRen.AMMOVRE_COD_MOVIM in ('ALCN','PRTC','PROG','AMPL') AND \n  \tRen.AMMOVRE_ID_POLIZA < 8000000\n)\n\n--fin de mes\nUNION ALL\n\nselect \n\tapolclav,\n\tfecha,\n\t0 as Tipo\n\tfrom\n\t\tPolizasEstudio pol\t\n\tcross join \n\t(\n\t\tselect to_date('{{DIARIZACIONES_INICIO}}') as fecha\n\t\tunion all\n\t\tselect date_add(to_date(FinMes),1) as fecha\n\t\tfrom \n\t\t\tCsvMeses \n\t\twhere FinMes between to_date('{{DIARIZACIONES_INICIO}}') and date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)\n\t) as sub\n\twhere fecha between FechaEntradaEstudio and date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)\n\t\n\n--fin de ano\nUNION ALL\nselect \n\tapolclav,\n\tfecha,\n\t9 as Tipo\n\tfrom\n\t\tPolizasEstudio pol\t\n\tcross join \n\t(\n\t\tselect to_date('{{DIARIZACIONES_INICIO}}') as fecha\n\t\tunion \n \t\tselect \n\t\t\tdate_add(to_date(FinMes),1) as fecha\n\t\tfrom \n\t\t\tCsvMeses \n\t\twhere year(FinMes) between  year(to_date('{{DIARIZACIONES_INICIO}}')) and year(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1))-1\n\t \t\tand month(FinMes) = 12\n\t \t\tor month(FinMes) = month(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)) - 1 and year(FinMes) = year(date_add(to_date('{{DIARIZACIONES_FECHA}}'),1))   \n\t) as sub\n\twhere fecha between FechaEntradaEstudio and date_add(to_date('{{DIARIZACIONES_FECHA}}'),1)\n","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"MESES","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2067.764716311156,"y":332.85877058242}},"configuration":{"query":"CREATE TEMPORARY TABLE CsvMeses USING PARQUET OPTIONS (path '{{NINF_STAGING}}/MESES')\n","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterTgrrecib","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2290.134813470972,"y":1466.4284286378856}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterTgrrecib\nAS SELECT \n   CAST(GRRECIB_FECH_VENC as date) as GRRECIB_FECH_VENC,\n   CAST(GRRECIB_FECH_EFE as date) as GRRECIB_FECH_EFE,\n   CAST(GRRECIB_ID_ADHES as bigint) as GRRECIB_ID_ADHES,\n   CAST(GRRECIB_EMPRESA as smallint) as GRRECIB_EMPRESA,\n   CAST(GRRECIB_TIP_RECI as varchar(3)) as GRRECIB_TIP_RECI,\n   CAST(GRRECIB_FREC_PAGO as varchar(1)) as GRRECIB_FREC_PAGO,\n   CAST(GRRECIB_ESTADO as varchar(2)) as GRRECIB_ESTADO,\n   CAST(GRRECIB_REF_RECIBO as bigint) as GRRECIB_REF_RECIBO,\n   CAST(GRRECIB_PRODUCTO as smallint) as GRRECIB_PRODUCTO\nfrom TGRRECIB","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"Step1","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2524.030996775541,"y":799.2695957347595}},"configuration":{"sql":"SELECT \n/*+ SKEW('tau', ('AUDACON_ID_RAMO', 'audacon_ffin_contr', 'AUDACON_SER_DES_VE', 'AUDACON_ID_EMPRESA')) */ \n/*+ SKEW('FilterTaudacon', ('AUDACON_ID_RAMO', 'audacon_ffin_contr', 'AUDACON_SER_DES_VE', 'AUDACON_ID_EMPRESA')) */ \n\ttau.audacon_ffin_contr,\n\ttau.AUDACON_ID_SOLICIT, \n\txpol.*\nFROM Step0 xpol\n\tLEFT JOIN FilterTaudacon tau \n \t\t\t\ton xpol.idSolicitud\t= tau.AUDACON_ID_SOLICIT\n\t\t\t\t\tand 1 = tau.AUDACON_ID_RAMO\n\t\t\t\t\tand year(tau.audacon_ffin_contr) not in (0001,1900)\n\t\t\t\t\tand tau.AUDACON_SER_DES_VE in ('A', 'B')\n\t\t\t\t\tand xpol.IdEmpresa= tau.AUDACON_ID_EMPRESA","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"Step2","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2524.27866427147,"y":916.2347953754502}},"configuration":{"sql":"SELECT \n\tneg.IdTipoSubNegocio, \n\txpol.*\nFROM Step1 xpol\n\tLEFT JOIN FilterNegocios neg \n \t\t\t\ton xpol.IdNegocio = neg.IdNegocio ","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"Step3","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2524.3270631927485,"y":1054.3148726109766}},"configuration":{"sql":"SELECT \n\txpc.Flota, \n\txpc.Colectivo, \n\txpol.*\nFROM Step2 xpol\n\tJOIN FilterPolizasComun xpc\n \t\t\t\ton xpol.apolclav = xpc.apolclav ","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"Step4","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2523.739788257721,"y":1190.1055405315847}},"configuration":{"sql":"SELECT \n/*+ SKEW('TUC', ('UCNEGME_F_ALTA', 'UCNEGME_F_BAJA')) */ \n/*+ SKEW('FilterTucnegme', ('UCNEGME_F_ALTA', 'UCNEGME_F_BAJA')) */ \n/*+ SKEW('xpol', ('Flota', 'Colectivo', 'FIni')) */ \n/*+ SKEW('Step3', ('Flota', 'Colectivo', 'FIni')) */ \n\tTUC.UCNEGME_ID_MEDIADO, \n\tTUC.UCNEGME_ID_EMPRESA, \n\txpol.*\nFROM Step3 xpol\n\tLEFT JOIN FilterTucnegme TUC  \n\t\t\t  ON case\n\t\t\t\t  when xpol.Flota='0' then xpol.Colectivo\n\t\t\t\t  else xpol.Flota\n\t\t\t  end = TUC.UCNEGME_ID_NEGOCIO \n\t\t\t  and TUC.UCNEGME_F_ALTA <= xpol.FIni   \n\t\t\t  and NVL(TUC.UCNEGME_F_BAJA,TO_DATE('2050-12-31')) > xpol.FIni","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"Step0","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2523.65698259092,"y":668.4733965704161}},"configuration":{"sql":"SELECT \n\tPerEst.FIni, \n\tPerEst.FFin, \n\tPerEst.IdPeriodo,\n\tPerEst.Cambio_Caracteristica, \n\tPerEst.Grupo,\n\tPerEst.FAno, \n\txpol.FechaMovini,\n\txpol.FechaMovFin,\n\txpol.apolclav,\n\txpol.idSolicitud,\n\txpol.IdEmpresa,\n\txpol.IdNegocio\nFROM PeriodosEstudioGrupos PerEst\n\t  join FilterPolizas xpol \n\t   \t\ton CAST(PerEst.apolclav as INT) = CAST(xpol.apolclav AS INT)\n\t   \t\t\tand CAST(PerEst.FIni AS DATE) between CAST(xpol.FechaMovini AS DATE) and CAST(xpol.FechaMovFin AS DATE)","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"Step5","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2523.912634126022,"y":1331.3094694875442}},"configuration":{"sql":"SELECT \n/*+ SKEW('xpol', ('IdEmpresa', 'FecDesde', 'FecHasta')) */ \n/*+ SKEW('FilterXESTRCOMER_PERSONAL', ('IdEmpresa', 'FecDesde', 'FecHasta')) */ \n\tMED.IdPersonalComercial, \n--\tMED.IdEmpresa as IdEmpresaM, \n\txpol.*\nFROM Step4 xpol\n\tLEFT JOIN FilterXESTRCOMER_PERSONAL MED \n\t\t\t\tON MED.IdPersonalComercial = xpol.UCNEGME_ID_MEDIADO \n\t\t\t\t\tAND MED.IdEmpresa = xpol.UCNEGME_ID_EMPRESA \n\t\t\t\t\tAND MED.FecDesde <= xpol.FIni \n\t\t\t\t\tAND MED.FecHasta > xpol.FIni ","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"Step6","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2524.306227249768,"y":1466.7577301815904}},"configuration":{"sql":"SELECT \n/*+ SKEW('Rec', ('GRRECIB_EMPRESA', 'GRRECIB_FECH_EFE')) */ \n  Rec.GRRECIB_REF_RECIBO, \n  Rec.GRRECIB_EMPRESA, \n  Rec.GRRECIB_PRODUCTO, \n  Rec.GRRECIB_FREC_PAGO,\n  xpol.*\nFROM Step5 xpol\n\tleft join FilterTgrrecib Rec \n\t\t\t on Rec.GRRECIB_ID_ADHES=xpol.apolclav                 \n\t\t\t\t and Rec.GRRECIB_EMPRESA=xpol.IdEmpresa                  \n\t\t\t\t and Rec.GRRECIB_FECH_EFE <= xpol.FIni   ","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"Step7","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2524.5258285390664,"y":1601.1056298606372}},"configuration":{"sql":"SELECT \n/*+ SKEW('DESG', ('GRDESGL_REF_RECIBO', 'GRDESGL_EMPRESA')) */ \n/*+ SKEW('FilterTGRDESGL', ('GRDESGL_REF_RECIBO', 'GRDESGL_EMPRESA')) */ \n  max(DESG.GRDESGL_COD_GARAN) as GRDESGL_COD_GARAN, \n  xpol.IdPeriodo,\n  xpol.apolclav,\n  xpol.FIni,\n  xpol.FFin, \n  MAX(\n\t  case \n\t\t  when xpol.GRRECIB_FREC_PAGO='A' then 1\n\t\t  when xpol.GRRECIB_FREC_PAGO='S' then 2\n\t\t  when xpol.GRRECIB_FREC_PAGO='T' then 3\n\t\t  when xpol.GRRECIB_FREC_PAGO='M' then 4\n\t\t  when xpol.GRRECIB_FREC_PAGO='P' then 5\n\t\t  else 1\n\t  end\n  ) as FrecuenciaPago,\n  xpol.GRRECIB_PRODUCTO,\n  xpol.Cambio_Caracteristica,\n  xpol.Grupo,\n  xpol.Colectivo,\n  xpol.Flota,\n  xpol.IdPersonalComercial,\t\t\n  xpol.FAno,\n  xpol.IdTipoSubNegocio,\n  xpol.audacon_ffin_contr,\n  xpol.FechaMovini\nFROM Step6 xpol\n\tleft join FilterTGRDESGL DESG        \n\t\t\t\t on DESG.GRDESGL_REF_RECIBO = xpol.GRRECIB_REF_RECIBO \n\t\t\t\t \tand DESG.GRDESGL_EMPRESA = xpol.GRRECIB_EMPRESA \n\t\t\t\t\tand DESG.GRDESGL_IMPORTE > 0 \n\t\t\t\t\tand DESG.GRDESGL_COD_DESGL in (1,14,17)\n--moved here from step 7\nGROUP BY\n\txpol.IdPeriodo,\n\txpol.apolclav,\n\txpol.FIni,\n\txpol.FFin,\n--\tFIni, ?es redundante?\n\txpol.Cambio_Caracteristica,\n\txpol.Grupo,\n\txpol.Colectivo,\n\txpol.Flota,\n\txpol.IdPersonalComercial,\t\t\n\txpol.FAno,\n\txpol.IdTipoSubNegocio,\n\txpol.audacon_ffin_contr,\n\txpol.GRRECIB_PRODUCTO,\n\txpol.FechaMovini","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"DiarizacionPolizas2Modulos","stepType":"Transformation","className":"TriggerTransformStep","classPrettyName":"Trigger","arity":["BinaryToNary","UnaryToNary","NaryToNary"],"writer":{"saveMode":"Overwrite","tableName":"","partitionBy":"","errorTableName":""},"description":"","uiConfiguration":{"position":{"x":2977.780867690316,"y":1738.5866860257752}},"configuration":{"sql":"SELECT\n\tDP.IdPeriodo,    \n\tDP.apolclav,    \n\tDP.FIni,    \n\tDP.FFin,    \n\tdatediff(DP.FFin,DP.FIni)+1 as NDias,\n\tmax(DP.RcObligatorio) AS RcObligatorio, \n\tmax(DP.RcVoluntario) AS RcVoluntario,\n\t--MAX(\n\t--case when NVL(xpol.GRDESGL_COD_GARAN,CAST(PG.Da?osPropios AS INT)*3)=3 then 1\n\t--\telse 0 end as DanosPropios,\n\t--end) as DanosPropios,\n\tmax(DP.Accidentes) AS Accidentes,\n\tmax(DP.Robo) AS Robo,\n\tmax(DP.DefensaJuridica) AS DefensaJuridica,\n\tmax(DP.Acm) AS Acm,\n\tmax(DP.Lunas) AS Lunas,\n\tmax(DP.Incendios) AS Incendios,\t\n\tmax(DP.GarantiaMecanica) AS GarantiaMecanica,\n\t0 as Renting,\n\tmax(DP.FrecuenciaPago) AS FrecuenciaPago, \n\tDP.Cambio_Caracteristica,    \n\tDP.Grupo,    \n\tDP.Ano,\n\t  case when FP.SitPoliza = \"\\\\x00\"\n\t\t  then NULL\n\t\t  else FP.SitPoliza\n\t  end\n\tas SituacionPolizas,    \n\tFP.Producto,    \n\tFP.TipoPersona,\n\t\tcast(case \n\t\t\twhen day(DP.FIni)>=day(FP.FechaEntrada) then (datediff(DP.FIni,FP.FechaEntrada)/365)\n\t\t\telse ((datediff(DP.FIni,FP.FechaEntrada)-30)/365)\n\t \t\tend \n\t\tas smallint) \n\tas AntPoliza,\n\tcast(case \n\t\t\twhen day(DP.FIni)>=day(FP.Frt) then (datediff(DP.FIni,FP.Frt)/365)\n\t\t\telse ((datediff(DP.FIni,FP.Frt)-30)/365)\n\t \tend as smallint) \n\tas AntCarnetConductor,\n\tcast(case \n\t\t\twhen day(DP.FIni)>=day(FP.FnacTomador) then (datediff(DP.FIni,FP.FnacTomador)/365)\n\t\t\telse ((datediff(DP.FIni,FP.FnacTomador)-30)/365)\n\t \tend as smallint) \n\tas EdadTomador,\n\tcast(case \n\t\t\twhen day(DP.FIni)>=day(FP.FnacConductor) then (datediff(DP.FIni,FP.FnacConductor)/365)\n\t\t\telse ((datediff(DP.FIni,FP.FnacConductor)-30)/365)\n\t \tend as smallint) \n\tas EdadConductor,\n\tFP.NifTomador,    \n\tFP.IdModelo,\n\tcast(case \n\t\t\twhen day(DP.FIni)>=day(FP.FechaConstruccion) then (datediff(DP.FIni,FP.FechaConstruccion)/365)\n\t\t\telse ((datediff(FIni,FP.FechaConstruccion)-30)/365)\n\t \tend as smallint) \n\tas AntVehiculo,\n\t--a?oconstruccion,    \n\tFP.SexoTomador,    \n\tFP.CodPostal,\n\tcast(case \n\t\t  when FP.FRTCROcasional is null then null\n\t\t  when day(DP.FIni)>=day(FP.FRTCROcasional) then (datediff(DP.FIni,FP.FRTCROcasional)/365)\n\t\t  else ((datediff(DP.FIni,FP.FRTCROcasional)-30)/365)\n\t \tend as smallint)\n\tas AntCarnetConductorOcasional,\n\tFP.RelacionCROConductor,    \n\tcast(case \n\t\t\twhen FP.FNacCROcasional IS null then null\n\t\t\twhen day(DP.FIni)>=day(FP.FNacCROcasional) then (datediff(DP.FIni,FP.FNacCROcasional)/365)\n\t\t\telse ((datediff(DP.FIni,FP.FNacCROcasional)-30)/365)\n\t\t end as smallint)\n\tas EdadConductorOcasional,\n\t  case \n\t\t  when FP.SexoCROcasional='M' then 2 \n\t\t  when FP.SexoCROcasional='H' then 1 \n\t\t  else FP.SexoCROcasional \n\t  end \n\tas SexoCROcasional,\n\tcast(\n\t\tcase\n\t\t\twhen FP.ValorVehiculo>9000000 then 9000000\n\t\t\telse FP.ValorVehiculo\n\t\tend + FP.ValorAccesorios as decimal(9,2)) \n\tas CapitalAsegurado,\n\tFP.PresenciaAsnef,    \n\tFP.RiskScore,    \n\tFP.SeverityScore,    \n\tFP.NumPlazas,    \n\tFP.Peso,    \n\t--xpol.AnoAdquisicion,    \n\tFP.CondHabitual,    \n\tcase when FP.UsoVehiculo='1050' then '105' else FP.UsoVehiculo end as UsoVehiculo,     \n\tFP.codCoefBonificacion,    \n\tFP.NivelBonificacion\nFROM DiarizacionPolizas DP\nJOIN PolizasFull FP\n ON \n \tDP.apolclav = FP.apolclav AND\n\tDP.FechaMovini = FP.FechaMovini\nGROUP BY\n\tDP.IdPeriodo,\n\tDP.apolclav,\n\tDP.FIni,\n\tDP.FFin,\n--\tFIni, ?es redundante?\n\tDP.Cambio_Caracteristica,\n\tDP.Grupo,\n\tDP.Colectivo,\n\tDP.Flota,\n\tDP.IdPersonalComercial,\t\t\n\tDP.Ano,\n\tDP.IdTipoSubNegocio,\n\tDP.audacon_ffin_contr,\n\t\n\tFP.FechaEntrada,\n\tFP.SitPoliza ,\n\tFP.Producto,\n\tFP.TipoPersona,\n\tFP.Frt,\n\tFP.FnacTomador,\n\tFP.FnacConductor,\n\tFP.FRTCROcasional,\n\tFP.RelacionCROConductor,\n\tFP.FNacCROcasional,\n\tFP.SexoCROcasional,\n\tFP.NifTomador,\n\tFP.IdModelo,\n\tFP.FechaConstruccion,\t\t\n\t--a?oconstruccion,\n\tFP.SexoTomador,\n\tFP.CodPostal,\n\tFP.ValorVehiculo,\n\tFP.ValorAccesorios ,\n\tFP.DuracionContratoRenting,\n\tFP.PresenciaAsnef,\n\tFP.RiskScore,\n\tFP.SeverityScore,\n\tFP.NumPlazas,\n\tFP.Peso,\n\t--xpol.A?oAdquisicion,\n\tFP.CondHabitual,\n\tFP.UsoVehiculo, \n\tFP.codCoefBonificacion,\n\tFP.NivelBonificacion","inputSchemas":"[]","executeSqlWhenEmpty":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterPolizas","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2291.457406036663,"y":669.1529082682919}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterPolizas \n AS SELECT \tTO_DATE(FechaMovini) as FechaMovini,\n\t\t\tTO_DATE(FechaMovFin) as FechaMovFin,\n\t\t\tCAST(Apolclav AS INT) as apolclav,\n\t\t\tCAST(idSolicitud AS BIGINT) AS \tidSolicitud,\n\t\t\tCAST(IdEmpresa AS smallint) as IdEmpresa,\n\t\t\tCAST(IdNegocio AS VARCHAR(8)) as IdNegocio\n\tFROM XPOLIZAS","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDPolizasFull","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2977.6537942514283,"y":1601.983172501084}},"configuration":{"query":"CREATE TEMPORARY VIEW PolizasFull\n AS SELECT TO_DATE(FechaMovini) as FechaMovini,\n\tTO_DATE(FechaMovFin) as FechaMovFin,\n\tCAST(Apolclav AS INT) as apolclav,\n\tTO_DATE(FechaEntrada) as FechaEntrada,\n\tTO_DATE(Frt) as Frt,\n\tTO_DATE(FnacTomador) as FnacTomador,\n\tTO_DATE(FnacConductor) as FnacConductor,\n\tTO_DATE(FRTCROcasional) as FRTCROcasional,\n\tTO_DATE(FNacCROcasional) as FNacCROcasional,\t\n\tTO_DATE(FechaConstruccion) as FechaConstruccion,\t\t\n\tCAST(idSolicitud AS BIGINT) AS \tidSolicitud,\n\tCAST(IdEmpresa AS smallint) as IdEmpresa,\n\tCAST(SitPoliza AS VARCHAR(1)) as SitPoliza,\n\tCAST(Producto AS VARCHAR(1)) as Producto,\n\tCAST(TipoPersona AS VARCHAR(1)) as TipoPersona,\n\tCAST(RelacionCROConductor AS CHAR(1)) as RelacionCROConductor,\n\tCAST(SexoCROcasional AS CHAR(1)) as SexoCROcasional,\n\tCAST(NifTomador AS VARCHAR(10)) as NifTomador,\n\tCAST(IdModelo AS INT) as IdModelo,\n\t--a?oconstruccion\n\tCAST(SexoTomador AS VARCHAR(1)) as SexoTomador,\n\tCAST(CodPostal AS VARCHAR(5)) as CodPostal,\n\tCAST(ValorVehiculo AS INT) as ValorVehiculo,\n\tCAST(ValorAccesorios AS INT) as ValorAccesorios,\n\tCAST(DuracionContratoRenting AS smallint) as DuracionContratoRenting,\n\tCAST(PresenciaAsnef AS CHAR(1)) as PresenciaAsnef,\n\tCAST(RiskScore AS CHAR(1)) as RiskScore,\n\tCAST(SeverityScore AS CHAR(1)) as SeverityScore,\n\tCAST(NumPlazas AS INT) as NumPlazas,\n\tCAST(Peso AS INT) as Peso,\n\t--A?oAdquisicion,\n\tCAST(CondHabitual AS smallint) as CondHabitual,\n\tCAST(UsoVehiculo AS VARCHAR(4)) as UsoVehiculo,\n\tCAST(codCoefBonificacion AS VARCHAR(8)) as codCoefBonificacion,\n\tCAST(NivelBonificacion AS INT) as NivelBonificacion,\n\tCAST(IdNegocio AS VARCHAR(8)) as IdNegocio\t\nFROM XPOLIZAS","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterPolizasComun","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2291.3405539249516,"y":1054.057158735446}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterPolizasComun \n AS SELECT \tCAST(apolclav AS INT) as apolclav,\n\t\t\tCAST(Colectivo as VARCHAR(8)) as Colectivo,\n\t\t\tCAST(Flota as VARCHAR(8)) as Flota\n\tFROM XPOLIZAS_COMUN","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDPolizasEstudio","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2067.444623522612,"y":216.97971708540285}},"configuration":{"query":"CREATE TEMPORARY VIEW PolizasEstudio \n AS SELECT \tCAST(apolclav AS INT) as apolclav,\n\t\t\tCASE \n\t\t\t  WHEN FechaEntrada > '{{DIARIZACIONES_INICIO}}' THEN TO_DATE(FechaEntrada)\n\t\t\t  ELSE TO_DATE('{{DIARIZACIONES_INICIO}}') \n\t\t\tEND AS FechaEntradaEstudio,\n\t\t\tTO_DATE(FechaEntrada) AS FechaEntrada\n\tFROM XPOLIZAS_COMUN\nWHERE TO_DATE(FechaEntrada) <= TO_DATE('{{DIARIZACIONES_FECHA}}')","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterTaudacon","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2294.7154318074363,"y":798.6586122452314}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterTaudacon \n AS SELECT \tCAST(AUDACON_ID_SOLICIT AS bigint) as AUDACON_ID_SOLICIT,\n\t\t\tCAST(AUDACON_ID_EMPRESA AS smallint) as AUDACON_ID_EMPRESA,\n\t\t\tCAST(AUDACON_ID_RAMO AS smallint) as AUDACON_ID_RAMO,\n\t\t\tTO_DATE(audacon_ffin_contr) as audacon_ffin_contr,\n\t\t\tCAST(AUDACON_SER_DES_VE AS varchar(1)) as AUDACON_SER_DES_VE\n\tFROM TAUDACON\nWHERE AUDACON_ID_RAMO=1\n\t\t\tand AUDACON_SER_DES_VE in ('A','B')\n\t\t\tand year(TO_DATE(audacon_ffin_contr))!= 0001 and year(TO_DATE(audacon_ffin_contr)) != 1900","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterNegocios","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2294.715677332367,"y":915.6694847144703}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterNegocios \n AS SELECT \tCAST(neg.IdNegocio AS VARCHAR(8)) as IdNegocio,\n \t\t\tCAST(neg.IdTipoSubNegocio AS VARCHAR(2)) as IdTipoSubNegocio\n\tFROM NEGOCIOS_HISTORICO neg","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterTucnegme","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2292.465307015716,"y":1190.1948375542875}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterTucnegme \nAS SELECT \tCAST(UCNEGME_ID_NEGOCIO as varchar(8)) as UCNEGME_ID_NEGOCIO,\n\t\t\t CAST(UCNEGME_F_ALTA as date) as UCNEGME_F_ALTA,\n\t\t\t CAST(UCNEGME_F_BAJA as date) as UCNEGME_F_BAJA,\n\t\t\t CAST(UCNEGME_ID_MEDIADO as int) as UCNEGME_ID_MEDIADO,\n\t\t\t CAST(UCNEGME_ID_EMPRESA  as smallint) as UCNEGME_ID_EMPRESA\n\tFROM TUCNEGME","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterXESTRCOMER_PERSONAL","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2292.4655250905525,"y":1331.958014273713}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterXESTRCOMER_PERSONAL \nAS SELECT  CAST(IdPersonalComercial as int) as IdPersonalComercial,\n\t\t   CAST(IdEmpresa as smallint) as IdEmpresa,\n\t\t   CAST(FecDesde as date) as FecDesde,\n\t\t   CAST(FecHasta as date) as FecHasta    \n\tFROM XESTRCOMER_PERSONAL","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterTammovre","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2751.5079847711154,"y":769.4058513640098}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterTammovre \n AS SELECT \tCAST(AMMOVRE_COD_MOVIM AS VARCHAR(4)) as AMMOVRE_COD_MOVIM,\n\t\t\tCAST(AMMOVRE_ID_POLIZA AS BIGINT) AS AMMOVRE_ID_POLIZA,\n\t\t\tTO_DATE(AMMOVRE_F_EFECTO) as AMMOVRE_F_EFECTO,\n\t\t\tCAST(AMMOVRE_DURACION AS smallint) as AMMOVRE_DURACION,\n\t\t\tCAST(AMMOVRE_ID_SECUEN AS int) as AMMOVRE_ID_SECUEN,\n\t\t\tCAST(AMMOVRE_ESTADO AS VARCHAR(1)) as AMMOVRE_ESTADO\n\tFROM TAMMOVRE\nWHERE AMMOVRE_COD_MOVIM in ('ALCN','PRTC','PROG','AMPL')\n\tAND CAST(AMMOVRE_ID_POLIZA AS BIGINT)\t<\t8000000 ","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterTGRDESGL","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2291.847084436771,"y":1600.8663517298505}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterTGRDESGL\nAS SELECT \n   CAST(Desg.GRDESGL_COD_GARAN AS smallint) AS GRDESGL_COD_GARAN,\n\tCAST(Desg.GRDESGL_REF_RECIBO AS bigint) AS GRDESGL_REF_RECIBO,\n\tCAST(Desg.GRDESGL_EMPRESA AS smallint) AS GRDESGL_EMPRESA,\n\tCAST(Desg.GRDESGL_IMPORTE AS decimal(15,4)) AS GRDESGL_IMPORTE,\n\tCAST(Desg.GRDESGL_COD_DESGL AS smallint) AS GRDESGL_COD_DESGL,\n\tCAST(Desg.GRDESGL_RAMO AS smallint) AS GRDESGL_RAMO\nfrom TGRDESGL Desg\nwhere \n\tDesg.GRDESGL_COD_DESGL in (1,14,17)\n\tand\n\tDesg.GRDESGL_IMPORTE > 0\n\tand\n\tDesg.GRDESGL_EMPRESA in (1,3)\n\tand\n\tyear(Desg.FEC_GENERACION) >= '{{DIARIZACIONES_ANO_RECIBOS}}'","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"XDFilterProductosGarantias","stepType":"Input","className":"CrossdataInputStep","classPrettyName":"Crossdata","arity":["NullaryToNary"],"writer":{"saveMode":"Append","tableName":"","partitionBy":"","errorTableName":""},"uiConfiguration":{"position":{"x":2528.118670329916,"y":1738.1288399003479}},"configuration":{"query":"CREATE TEMPORARY VIEW FilterProductosGarantias\nAS SELECT \n\tCAST(PG.RCObligatorio AS smallint) as RCObligatorio,\n\tCAST(PG.RCVoluntario AS smallint) * 2 as RCVoluntario,\n\t--CAST(PG.Da?osPropios AS tinyint) as Da?osPropios,\n\tCAST(PG.Robo AS smallint) * 5 as Robo,\n\tCAST(PG.DefensaJuridica AS smallint) * 6 as DefensaJuridica,\n\tCAST(PG.Acm AS smallint) * 7 as Acm,\n\tCAST(PG.Lunas AS smallint) * 8 as Lunas,\n\tCAST(PG.Accidentes AS smallint) * 4 as Accidentes,\n\tCAST(PG.Incendio AS smallint) * 9 as Incendio,\n\tCAST(PG.Producto AS smallint) as Producto\nFROM PRODUCTOSGARANTIAS PG","tlsEnabled":true},"supportedEngines":["Batch"],"executionEngine":"Batch"},{"name":"Parquet","stepType":"Output","className":"ParquetOutputStep","classPrettyName":"Parquet","arity":["NullaryToNullary","NaryToNullary"],"writer":{"saveMode":"Append"},"description":"","uiConfiguration":{"position":{"x":3464.5595378754774,"y":1736.956891208603}},"configuration":{"path":"{{NINF_CONSOLIDATED}}/tmp/validatingPolizas","errorSink":false,"saveOptions":"[]"},"supportedEngines":["Streaming","Batch"],"executionEngine":"Batch"}],"edges":[{"origin":"Renting","destination":"RentingAcum"},{"origin":"RentingAcum","destination":"RentingTotal"},{"origin":"RentingTotal","destination":"RentingTotalDistinct"},{"origin":"RentingTotalDistinct","destination":"RentingPeriodos"},{"origin":"RentingPeriodos","destination":"RentingPeriodosGroup"},{"origin":"RentingPeriodosGroup","destination":"DiarizacionPolizas"},{"origin":"GroupFechas","destination":"PeriodosEstudio"},{"origin":"PeriodosEstudio","destination":"PeriodosEstudioGrupos"},{"origin":"UnionFechas","destination":"GroupFechas"},{"origin":"MESES","destination":"UnionFechas"},{"origin":"Step1","destination":"Step2"},{"origin":"Step2","destination":"Step3"},{"origin":"Step3","destination":"Step4"},{"origin":"Step4","destination":"Step5"},{"origin":"Step5","destination":"Step6"},{"origin":"Step7","destination":"DiarizacionPolizas"},{"origin":"Step6","destination":"Step7"},{"origin":"Step0","destination":"Step1"},{"origin":"PeriodosEstudioGrupos","destination":"Step0"},{"origin":"DiarizacionPolizas","destination":"DiarizacionPolizas2Modulos"},{"origin":"XDFilterPolizas","destination":"Step0"},{"origin":"XDPolizasFull","destination":"DiarizacionPolizas2Modulos"},{"origin":"XDFilterPolizasComun","destination":"Step3"},{"origin":"XDPolizasEstudio","destination":"UnionFechas"},{"origin":"XDFilterTgrrecib","destination":"Step6"},{"origin":"XDFilterTaudacon","destination":"Step1"},{"origin":"XDFilterNegocios","destination":"Step2"},{"origin":"XDFilterTucnegme","destination":"Step4"},{"origin":"XDFilterXESTRCOMER_PERSONAL","destination":"Step5"},{"origin":"XDFilterTammovre","destination":"Renting"},{"origin":"XDFilterTGRDESGL","destination":"Step7"},{"origin":"XDFilterProductosGarantias","destination":"DiarizacionPolizas"},{"origin":"DiarizacionPolizas2Modulos","destination":"Parquet"}]},"executionEngine":"Batch","uiSettings":{"position":{"x":-1535.7811979952712,"y":-989.9224945350575,"k":0.7156774005104481}},"lastUpdateDate":"2018-06-13T07:53:48Z","version":1,"group":{"id":"57ef19c5-1f3c-4a65-9f6c-9793d3450aff","name":"/home/mutua/diarizaciones/apaniagua"},"status":{"id":"9d4db8d6-d9d1-4541-aecd-0ae5738107b6","status":"Finished","statusInfo":"Workflow correctly finished in Marathon API","lastExecutionMode":"marathon","lastUpdateDate":"2018-06-13T08:44:52Z","lastUpdateDateWorkflow":"2018-06-13T07:53:48Z"}}